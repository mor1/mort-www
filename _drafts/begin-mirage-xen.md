Starting Mirage-Xen domains can be a bit opaque if, like me, you're not completely familiar with Xen. So I thought I'd make some notes on things I did and things I found useful.

# Installing Xen

ubuntu 13.04 + sudo apt-get install xen (...)

several tool chains -- chose to use xl as the best combination of simple and up-to-date

# Starting a domain

Fairly simple really, once you realise that a domain can start and exit so fast that the console gets torn down before it outputs anything: so start it paused and later, `unpause` it:

    xl [-v] create -c -p <config> # in one console
    xl unpause <domain>           # in another, output from the first stops

# Attaching disks

There are two sorts of disk device common in Mirage at this point: `Crunch` and `Fat`. The former is a simple in memory "encode your data as static values in a hashtable in big `.ml` file" device. This is fine for small, simple filesystems but gets a bit cumbersome with a large filesystem -- for example, my website generates a single 150MB+ `.ml` input file if I try to build it using `Crunch`. The latter, provided via the OPAM `fat-filesystem` package with code at  <http://github.com/mirage/ocaml-fat>, is the venerable MS-DOS `FAT16` filesystem (`FAT12` and `FAT32` aren't currently supported -- patches welcome!).

Anyway, you first need to mount the FAT image as a device

    losetup /dev/loop0 fat1.img

and then add to the domain configuration

    disk = [ '/dev/loop0,raw,xvda,rw' ] # 'raw' and ',rw' can be elided


# Bringing up the network

There are essentially three combinations of network backend for a  Mirage appliance, typically selected by the `MODE`, `NET` and `ADDR` environment variables at configure time (specific behaviour depends what is implemented in the `config.ml`). Each requires its network device configuring differently:

+ __UNIX/socket__ requires no configuration. The network device is configured with the loopback addres, `127.0.0.1`. Appliances can be run without requiring `root` privileges, assuming only non-privileged ports are bound to.

+ __UNIX/direct/dhcp__ requires no configuration assuming a DHCP server is running and can respond. The appliance must be run with `root` privileges to open the `tap0` device, whereupon the DHCP client in the appliance follows the usual protocol.

+ __UNIX/direct/static__ requires configuration of the network device. The appliance must run as `root` and, once started, requires the device to be statically allocated an IP address, netmask and gateway(s). Typically this is done by a sequence such as:

    $ sudo ./mir-appliance
    ...
    ^Z
    $ sudo ifconfig tap0 10.0.0.1 255.255.255.0 && fg

This results in the appliance running with a virtual network device that uses `tap0` as its bridge to the outside world.

+ __Xen/direct/dhcp__ requires the network device to be configured in the usual way, and a DHCP server to be running and able to respond to requests from the appliance. For example, a typical `.xl` config file autogenerated by `mirage` might look like:

```
# Generated by Mirage (Fri, 7 Feb 2014 18:23:54 GMT).

name = 'appliance-name'
kernel = '/full/path/to/appliance.xen'
builder = 'linux'
memory = 256

# You must define the network and block interfaces manually.

# The disk configuration is defined here:
# http://xenbits.xen.org/docs/4.3-testing/misc/xl-disk-configuration.txt
# An example would look like:
# disk = [ '/dev/loop0,,xvda' ]

# The network configuration is defined here:
# http://xenbits.xen.org/docs/4.3-testing/misc/xl-network-configuration.html
# An example would look like:
# vif = [ 'mac=c0:ff:ee:c0:ff:ee,bridge=br0' ]
```

The last line would then be edited to read:

```
vif = [ 'mac=c0:ff:ee:c0:ff:ee,bridge=xenbr0' ]
```

__NB__. If you edit an autogenerated `.xl` file, be sure to save it under a new name or in a different directory so that the next rebuild does not overwrite your changes.
